#!/bin/sh

export MYSQL_DATABASE="mp-test"
export MYSQL_ROOT_PASSWORD="test-root-password"
export MYSQL_USER="moneyprinter"
export MYSQL_PASSWORD="mp!QAZxsw2"

docker-compose -f docker/docker-compose.yml up -d db
docker-compose -f docker/docker-compose.yml build api

image=`docker-compose -f docker/docker-compose.yml ps -q db`

docker network create --driver bridge mp-net
docker run -dit --name db --network mp-net $image api
docker run -dit --name api --network mp-net $image api
docker network connect bridge mp-net

docker exec --tty $image mysql --user=$MYSQL_USER --password=$MYSQL_PASSWORD --database=$MYSQL_DATABASE --host=$MYSQL_HOST --execute="ALTER USER '$MYSQL_USER'@'%' IDENTIFIED WITH mysql_native_password BY '$MYSQL_PASSWORD'"
docker-compose -f docker/docker-compose.yml start -d api
