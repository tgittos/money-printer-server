#!/bin/bash

echo "Sourcing dev env from `pwd`/.env.dev"
source "`pwd`/.env.dev"

echo "Creating user $MP_API__USERNAME in mysql db with $MP_API__PASSWORD"
docker exec --tty $(docker-compose -f docker-compose.dev.yml ps -q mysql) /bin/bash -c "mysql --user=root --password='$MP_API__PASSWORD' --execute=\"CREATE USER '$MP_API__USERNAME' IDENTIFIED BY '$MP_API__PASSWORD'\""

echo "Creating db mp_matomo in mysql"
docker exec --tty $(docker-compose -f docker-compose.dev.yml ps -q mysql) /bin/bash -c "mysql --user=root --password='$MP_API__PASSWORD' --execute=\"CREATE SCHEMA mp_matomo;\""
docker exec --tty $(docker-compose -f docker-compose.dev.yml ps -q mysql) /bin/bash -c "mysql --user=root --password='$MP_API__PASSWORD' --database mp_matomo --execute=\"GRANT ALL PRIVILEGES ON *.* TO '$MP_API__USERNAME';\""

echo "Creating user $MP_API__USERNAME in pg with pw $MP_API__PASSWORD"
docker exec --tty $(docker-compose -f docker-compose.dev.yml ps -q pg) /bin/bash -c "psql -U postgres -c \"CREATE USER $MP_API__USERNAME WITH PASSWORD '$MP_API__PASSWORD'\""
docker exec --tty $(docker-compose -f docker-compose.dev.yml ps -q pg) /bin/bash -c "psql -U postgres -c \"ALTER USER $MP_API__USERNAME WITH SUPERUSER;\""

echo "Creating user $MP_STONKS__USERNAME in pg with pw $MP_STONKS__PASSWORD"
docker exec --tty $(docker-compose -f docker-compose.dev.yml ps -q pg) /bin/bash -c "psql -U postgres -c \"CREATE USER $MP_STONKS__USERNAME WITH PASSWORD '$MP_STONKS__PASSWORD'\""
docker exec --tty $(docker-compose -f docker-compose.dev.yml ps -q pg) /bin/bash -c "psql -U postgres -c \"ALTER USER $MP_STONKS__USERNAME WITH SUPERUSER;\""

echo "Creating db mp_stonks in pg"
docker exec --tty $(docker-compose -f docker-compose.dev.yml ps -q pg) /bin/bash -c "psql -U postgres -c \"CREATE DATABASE $MP_STONKS__SCHEMA;\""

echo "Creating db mp_dev in pg"
docker exec --tty $(docker-compose -f docker-compose.dev.yml ps -q pg) /bin/bash -c "psql -U postgres -c \"CREATE DATABASE $MP_API__SCHEMA;\""

echo "Creating db mp_test in pg"
docker exec --tty $(docker-compose -f docker-compose.dev.yml ps -q pg) /bin/bash -c "psql -U postgres -c \"CREATE DATABASE mp_test;\""

if [ $(docker-compose -f docker-compose.dev.yml ps -q api) ]; then
    echo "Migrating api db"
    docker exec --tty $(docker-compose -f docker-compose.dev.yml ps -q api) /bin/bash -c "cd /app/src/core && alembic upgrade head"
fi

if [ $(docker-compose -f docker-compose.dev.yml ps -q stonks) ]; then
    echo "Migrating stonks db"
    docker exec --tty $(docker-compose -f docker-compose.dev.yml ps -q stonks) /bin/bash -c "cd /app/src/stonk_server && alembic upgrade head"
fi

echo "Done"
